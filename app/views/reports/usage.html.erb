<!-- app/views/reports/usage.html.erb -->
<div class="container mx-auto px-4 py-6">
  <h1 class="text-3xl font-bold mb-4">Usage Report</h1>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            #
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Short URL
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Number of Clicks
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @grouped_visits.each_with_index do |(short_url, visits), index| %>
        <tr>
        <td class="px-6 py-4">
            <%= index + 1 %>
          </td>
          <td class="px-6 py-4 font-semibold">
            <a href="<%= request.base_url + '/urls/' + short_url %>" class="text-blue-600 hover:text-blue-800"
              target="_blank">
              <%= request.base_url + '/urls/' + short_url %>
            </a>
          </td>
          <td class="px-6 py-4 text-sm">
            <%= visits.count %>
          </td>
        </tr>
       <tr class="group cursor-pointer" onclick="toggleDetails(this)">
          <td colspan="3" class="px-6 py-4">
            <div class="flex items-center justify-center">
              <span class="text-sm">Show/Hide Details</span>
              <svg class="h-5 w-5 text-gray-500 group-hover:text-gray-700 transform transition-transform duration-300" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06-.02L10 10.44l3.71-3.25a.75.75 0 011.08 1.04l-4 3.5a.75.75 0 01-1.06 0l-4-3.5a.75.75 0 01-.02-1.06z" clip-rule="evenodd" />
              </svg>
            </div>
          </td>
        </tr>

        <tr class="hidden details-row">
          <td colspan="3">
            <table class="min-w-full divide-y divide-gray-200 mt-2">
              <thead>
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    IP Address
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Geolocation
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Timestamp
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200 max-h-48 overflow-y-scroll">
                <%= render partial: 'visit_row', collection: visits, as: :visit %>
              </tbody>
            </table>
          </td>
        </tr>

        <% end %>
      </tbody>
    </table>
  </div>

<div class="flex justify-between mt-4">
  <span class="pagy-info">
    Displaying items <b><%= @pagy.from %>-<%= @pagy.to %></b>
  </span>
  <nav class="pagy-nav pagination">
    <!-- Previous Page -->
    <span class="page prev <%= 'disabled:opacity-65 pointer-events-none' if @pagy.prev.nil? %>">
      <% if @pagy.prev %>
        <a href="<%= request.path %>?page=<%= @pagy.prev %>" rel="prev" aria-label="previous">‹&nbsp;Prev</a>
      <% else %>
        ‹&nbsp;Prev
      <% end %>
    </span>

    <!-- Current Page -->
    <span class="page active">
      <%= @pagy.page %>
    </span>

    <!-- Next Page -->
    <span class="page next <%= 'disabled:opacity-65 pointer-events-none' if @pagy.next.nil? %>">
      <% if @pagy.next %>
        <a href="<%= request.path %>?page=<%= @pagy.next %>" rel="next" aria-label="next">Next&nbsp;›</a>
      <% else %>
        Next&nbsp;›
      <% end %>
    </span>
  </nav>
</div>

</div>

<script>
  function toggleDetails(row) {
    const detailsRow = row.nextElementSibling;
    const icon = row.querySelector('svg');
    if (detailsRow.classList.contains('hidden')) {
      detailsRow.classList.remove('hidden');
      icon.classList.add('rotate-180');
    } else {
      detailsRow.classList.add('hidden');
      icon.classList.remove('rotate-180');
    }
  }
</script>